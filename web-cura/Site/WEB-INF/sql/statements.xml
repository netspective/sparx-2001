<?xml version="1.0"?>

<xaf>
	<!-- when no <param> tags provided, params will be passed in manually in Java code -->

	<sql-statements package="security">

		<!-- these security statements are used in AppLoginDialog -->

		<statement name="login-info">
			select person_id, password, quantity
			from person_login
			where user_id = ?
			and login_status = 1     /* active status only */
		</statement>

	</sql-statements>

	<sql-statements package="person">

		<statement name="registration">
			select * from person where person_id = ?
		</statement>

		<statement name="active-org-memberships">
			select org.org_id, org.org_name
			from org, personorg_relationship por
			where por.parent_id = ?
			and por.record_status_id = 1  /* active status only */
			and por.rel_type = 0       /* member of organization */
			and por.rel_org_id = org.org_id /* join to get org_name */
		</statement>

	</sql-statements>

	<sql-statements package="org">

		<statement name="name-only">
			select org_name from org where org_id = ?
			<params>
				<param value="request:org_id"/>
			</params>
		</statement>

		<statement name="registration">
			select
				org_code as "Code",
				org_abbrev as "Abbrev",
				org_ownership.caption as "Ownership",
				ticker_symbol as "Ticker",
				sic_code as "SIC",
				employees as "Employees",
				time_zone as "Time Zone"
			from org, org_ownership
			where org_id = ?
			and org.ownership = org_ownership.id (+)
			<params>
				<param value="request:org_id"/>
			</params>
			<report heading="Overview">
				<banner-item caption="Edit" url="config-expr:index.jsp?cmd=dialog,org.registration,edit&amp;org_id=${request:org_id}"/>
				<banner-item caption="Delete" url="config-expr:index.jsp?cmd=dialog,org.registration,delete&amp;org_id=${request:org_id}"/>
			</report>
		</statement>

		<statement name="classification">
			select 'Industry', ind_enum.caption
			from org, org_industry ind, org_industry_enum ind_enum
			where org.org_id = ?
			and org.org_id = ind.org_id
			and ind.org_industry = ind_enum.id
			union
			select 'Type', typ_enum.caption
			from org, org_type typ, org_type_enum typ_enum
			where org.org_id = ?
			and org.org_id = typ.org_id
			and typ.org_type = typ_enum.id
			<params>
				<param value="request:org_id"/>
				<param value="request:org_id"/>
			</params>
			<report heading="Classification"/>
		</statement>
	</sql-statements>

	<query-defn id="Organization">

		<!-- Fields -->
		<field id="org_id" caption="Account ID" join="org" column="org_id">
			<report heading="ID" url="create-app-url:/account/home.jsp?org_id=${.}" align="right"/>
		</field>
		<field id="org_code" caption="Account Code" join="org" column="org_code">
			<report heading="Code"/>
		</field>
		<field id="org_name" caption="Account Name" join="org" column="org_name" where-expr="upper(org.org_name)">
			<report heading="Name"/>
		</field>
		<field id="org_abbrev" caption="Account Abbreviation" join="org" column="org_abbrev" where-expr="upper(org.org_abbrev)">
			<report heading="Abbrev"/>
		</field>
		<field id="org_industry" caption="Account Industry" join="org_industry" column="org_industry" column-expr="org_industry_enum.caption">
			<report heading="Industry"/>
		</field>

		<!-- Joins -->
		<join id="org" table="org" auto-include="yes"/>
		<join id="org_industry" table="org_industry" condition="org.org_id = org_industry.org_id (+)" imply-join="org_industry_enum"/>
		<join id="org_industry_enum" table="org_industry_enum" condition="org_industry.org_industry = org_industry_enum.id (+)" imply-join="org_industry_enum"/>

		<select-dialog name="org_search" allow-debug="yes" show-output-dests="no" hide-readonly-hints="yes" heading="Search Accounts">
			<field.text query-field="org_code"/>
			<field.text query-field="org_name"/>
			<field.text query-field="org_abbrev"/>
			<field.select query-field="org_industry" choices="schema-enum:Org_Industry_Enum" prepend-blank="yes"/>
			<field.select name="sort_order"
					caption="Sort By"
					style="combo"
					choices="Name=org_name;Abbreviation=org_abbrev"/>
			<select>
				<display field="org_id"/>
				<display field="org_code"/>
				<display field="org_name"/>
				<display field="org_abbrev"/>
				<display field="org_industry"/>
				<order-by field="form:sort_order"/>

				<condition field="org_code" allow-null="no" comparison="starts-with" value="form:org_code" connector="and" bind-expr="upper(?)"/>
				<condition field="org_name" allow-null="no" comparison="starts-with" value="form:org_name" connector="and" bind-expr="upper(?)"/>
				<condition field="org_abbrev" allow-null="no" comparison="starts-with" value="form:org_abbrev" connector="and" bind-expr="upper(?)"/>
				<condition field="org_industry" allow-null="no" comparison="equals" value="form:org_industry" connector="and"/>
			</select>
			<director cancel-url="index.jsp" submit-caption="Search"/>
		</select-dialog>

	</query-defn>
</xaf>